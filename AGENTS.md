# working

automated work loop for github repositories. picks issues, plans, executes, reviews, and acts — all via `make work`. daily reflections via `make reflect`.

## build

```bash
make ci           # type checks + format checks + length checks + tests
make test         # tests only
make check-types  # type checks only
make check-format # format checks only
make check-length # file length lint check (500-line default)
make clean        # remove build artifacts
```

run a single test:

```bash
TL_PATH='?.tl;?/init.tl;/zip/.lua/?.tl;/zip/.lua/?/init.tl;/zip/.lua/types/?.d.tl;/zip/.lua/types/?/init.d.tl' o/bin/cosmic skills/pick/tools/test_list_issues.tl
```

## usage

```bash
# run full work loop for a repo
REPO=whilp/ah make work

# run individual work phases
REPO=whilp/ah make pick
REPO=whilp/ah make clone
REPO=whilp/ah make plan
REPO=whilp/ah make do
REPO=whilp/ah make check

# run reflect loop (this repo's workflow runs)
make reflect

# run individual reflect phases
make fetch
make analyze
make publish

# reflect on a specific date
DATE=2025-01-15 make reflect

# run dependency bump
REPO=whilp/working make bump
```

the work workflow runs hourly. the reflect workflow runs daily at 06:00 UTC. both support manual dispatch.

## setup

the workflows use a github app for authentication. a fresh installation token is generated at the start of each run via `actions/create-github-app-token`.

three secrets are required:

- `CLAUDE_CODE_OAUTH_TOKEN` — oauth token for claude API access.
- `APP_ID` — github app id.
- `APP_KEY` — PEM private key for the github app.

the github app needs installation access to target repos (ah, cosmic, working) with these permissions:

| permission | level | used for |
|---|---|---|
| contents | read and write | clone, push branches |
| issues | read and write | list issues, transition labels, comment |
| pull requests | read and write | create PRs |
| actions | read-only | list workflow runs, download logs and artifacts |
| metadata | read-only | required by github for all apps |

when the app's permissions are changed in GitHub App settings, the installation owner must accept the new permissions before they take effect. until accepted, tokens generated by `actions/create-github-app-token` still carry the old permissions. to accept: go to the GitHub App installation settings for the org/owner and approve the pending permission request.

## structure

```
Makefile              build, test, ci targets; cosmic/ah dependency fetching
work.mk               work loop targets (unstick → pick → clone → build → plan → do → push → check → act)
reflect.mk            reflect loop targets (fetch → analyze → summarize → publish)
lib/                  deterministic scripts (no agent invocation)
  build/              build-time utilities (lint)
  work/               work loop scripts (act, unstick)
tools/                shared tool modules (comment-issue, create-pr, set-issue-labels)
test/                 tests for shared modules
  tools/              tests for shared tool modules
skills/               agent skills and their tools
  pick/               select next issue from github
    SKILL.md          pick skill prompt
    tools/            tl tool modules (list-issues, count-open-prs, ensure-labels, get-prs-with-feedback)
    tests/            tests for pick tools
  plan/               research codebase and write a plan
    SKILL.md          plan skill prompt
    tests/            tests for plan lib modules
  do/                 execute the plan
    SKILL.md          do skill prompt
  check/              review execution against plan
    SKILL.md          check skill prompt
  reflect/            retrospective analysis of workflow runs
    SKILL.md          reflect skill prompt (fetch, analyze-run, summarize phases)
    tools/            tl tool modules (get-workflow-runs)
    tests/            tests for reflect tools
  triage/             review open issues, close stale ones, split oversized ones
    SKILL.md          triage skill prompt
    tools/            tl tool modules (close-issue, create-issue, grep-repo)
    tests/            tests for triage tools
  tests/              audit and improve tests
    SKILL.md          tests skill prompt
  bump/               check for dependency updates
    SKILL.md          bump skill prompt
    tools/            tl tool modules (get-latest-release, update-dep)
    tests/            tests for bump tools
.github/workflows/
  test.yml            CI: runs `make -j ci` on push/PR
  work.yml            scheduled work loop: runs `make work` hourly
  reflect.yml         daily reflect loop: runs `make reflect`
  bump.yml            manual dependency bump: runs `make bump`
```

## docs

- `docs/architecture.md` — tool modules, dependencies, ci
- `docs/work.md` — work loop design, convergence, tools
- `docs/reflect.md` — reflect loop design, phases, tools
- `docs/conventions.md` — teal patterns, testing, naming, commit format

## making changes

1. before starting work on a new problem, check the current branch with `git branch --show-current`. if on `main` (or another default branch), create and switch to a new feature branch (e.g. `git checkout -b issue-<number>-<short-description>`). never commit directly to `main`.
2. read the relevant skill SKILL.md and tool .tl files before editing.
3. every tool .tl file must have a corresponding test_*.tl file. tests live in a separate `tests/` subdirectory (`test/tools/` for shared tools, `skills/NAME/tests/` for skill tools) — not alongside the tool source. `ah` loads all `.tl` files in `tools/` directories as tools; keeping tests separate prevents them from being registered as tools.
4. run `make ci` before committing. all checks must pass.
5. use `component: action` format for commit messages and PR titles (e.g. `pick: add priority sorting`, `docs: update setup instructions`). lowercase, imperative. common components: skill names (`pick`, `plan`, `do`, `check`, `act`, `reflect`, `triage`, `bump`), `docs`, `ci`, `tools`.
6. tool modules return a table with `name`, `description`, `input_schema`, `execute`.
7. tests validate tool record structure and input validation (no external calls).
