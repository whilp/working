# Reflection: 2026-02-17

## Summary

7 work runs executed across the day for whilp/working, whilp/ah, and whilp/cosmic as 3-way parallel matrix jobs. 1 run succeeded (all 3 jobs passing); the other 6 failed — 2 due to GH_TOKEN auth failures, 3 due to cross-repo branch confusion and/or transport errors, and 1 success later in the day with plan retries. The day had one clean success run (22090655511), which produced 3 PRs across all 3 repos.

## Runs

| workflow | total | pass | fail | cancel |
|---|---|---|---|---|
| work | 7 | 1 | 6 | 0 |

Note: each run contains 3 parallel matrix jobs; overall run conclusion is failure if any job fails.

## Failure Analysis

### 1. GH_TOKEN not propagated to tools (runs 22081901002, 22082813358)

Two early runs (one manual dispatch, one scheduled) failed because the token generated by `actions/create-github-app-token` was not available to `gh` CLI invocations inside the agent's tool subprocesses. All pick-phase tools (`ensure_labels`, `list_issues`, `count_open_prs`) returned exit 4 with "gh auth login" errors.

```
ensure_labels (0.2s)
  errors: todo: To get started with GitHub CLI, please run:  gh auth login
error: no branch in o/pick/issue.json
make[1]: *** [work.mk:74: o/repo/sha] Error 1
```

This is a token scoping/inheritance issue between the GitHub Actions step environment and the agent's subprocess environment.

### 2. Cross-repo PR branch checkout (runs 22083221872, 22084316416)

After the auth issue was resolved, whilp/ah and whilp/cosmic jobs failed at clone because pick chose a PR (`work/35-a7f3c9e1`) from whilp/working and all three matrix jobs tried to clone the wrong repos and check out that branch. The pick skill lacks a repo-match guard — it picks PRs with `CHANGES_REQUESTED` without verifying the PR belongs to the target repo.

```
error: pathspec 'work/35-a7f3c9e1' did not match any file(s) known to git
make[1]: *** [work.mk:78: o/repo/sha] Error 1
```

### 3. comment_issue tool: invalid issue format (runs 22083221872, 22084316416)

The act phase `comment_issue` tool was passed `"whilp/working#37"` (full owner/repo#number format) instead of a bare integer. `gh issue comment` does not accept that format.

```
error: gh failed (exit 1): invalid issue format: "whilp/working#37"
```

### 4. Transport errors during plan/do (runs 22110191338, 22113838853)

whilp/cosmic jobs repeatedly hit `fetch failed: transport error` during the plan and do phases. This appears to be a sandbox network restriction preventing git/gh fetches from inside agent steps. Cosmic issue #290 and #193 both failed this way; #193 additionally hit the job-level timeout after 3 attempts.

```
error: fetch failed: transport error
##[error]must_produce: o/plan/plan.md not created
make[1]: *** [work.mk:102: o/plan/plan.md] Error 124
```

### 5. pr_limit exits as failure (runs 22110191338, 22113838853)

When whilp/ah hits the PR limit (≥5 open PRs), pick writes `{"error": "pr_limit"}` but `make work` still exits with code 2, marking the job as failed. This is expected behavior treated as an error at the CI level.

## Work Loop Outcomes

| run | repo | issue | verdict | pr |
|---|---|---|---|---|
| 22083221872 | whilp/working | PR #37 (triage skill) | pass | #37 (existing) |
| 22084316416 | whilp/working | PR #37 (triage skill) | pass | #37 (existing) |
| 22090655511 | whilp/cosmic | #267 (fix welcome) | pass | work/267-a3f8c2e1 |
| 22090655511 | whilp/ah | #185 (check phase docs) | pass | work/185-a3f7c291 |
| 22090655511 | whilp/working | #65 (pick error codes) | pass | work/65-a3f7c2e1 |
| 22110191338 | whilp/working | PR #61 (tests skill) | pass | #61 (existing) |
| 22110191338 | whilp/cosmic | #290 (doc depth) | failed | — |
| 22113838853 | whilp/working | PR #61 (tests skill) | pass | #61 (existing) |
| 22113838853 | whilp/cosmic | #193 (crypto) | failed | — |
| 22113838853 | whilp/ah | — | pr_limit | — |

PRs created: 3 (all from run 22090655511).
PR #61 (whilp/working) received multiple check-pass comments throughout the day without being merged.

## Patterns

- **Auth failures early in day**: Two runs failed with no-auth before the token propagation issue was resolved (likely a workflow fix between runs 22082813358 and 22083221872).
- **Cross-repo PR bleed**: The pick skill picks PRs with `CHANGES_REQUESTED` from other repos in the matrix — ah and cosmic pick up working's PRs and then fail at clone. Occurred in 2 consecutive runs.
- **Cosmic transport errors**: whilp/cosmic consistently hits network transport errors during plan/do. This is a recurring pattern; the sandbox network restrictions seem more aggressive for cosmic's larger dependency fetches.
- **PR #61 stale**: whilp/working PR #61 accumulated 8+ check-pass comments without being merged. The agent re-checks the same PR repeatedly instead of moving to other issues.
- **Plan timeout/retry working**: One cosmic plan timeout (run 22090655511) recovered after 2 failures on the 3rd attempt — retry logic functions correctly for timeouts.
- **False pass on incomplete do**: Run 22083221872 check passed despite 31 files differing from main instead of expected ~7; the check skill rationalized scope creep as acceptable.

## Recommendations

1. **Fix pick to filter PRs by repo**: The pick skill must only return PRs that belong to the target `REPO` being worked. Add a check: if `pr.headRepository.nameWithOwner != REPO`, skip it. Prevents cross-repo branch checkout failures.

2. **Fix comment_issue tool to accept owner/repo#number format**: The tool or act skill passes `"owner/repo#number"` strings; `gh issue comment` requires a bare integer. Strip the owner/repo prefix or parse the issue number before calling `gh`.

3. **Make pr_limit and no_issues exit 0**: Expected termination conditions (pr_limit, no_issues) should not cause make to exit non-zero. Either add a sentinel file that make checks, or change the pick target to exit 0 on expected conditions, so the job is marked success/skipped rather than failure.

4. **Investigate sandbox network restrictions for cosmic**: The `fetch failed: transport error` during plan/do is blocking cosmic work items. Determine whether the restriction is intentional and whether plan/do need to avoid live fetches, or whether network should be allowed in those phases.

5. **Prevent repeated re-checking of already-passed PRs**: PR #61 was check-passed 8+ times in one day. Pick should deprioritize PRs that already have a recent check-pass comment, or the act phase should update the PR label to indicate it's awaiting merge (not re-check).

6. **Tighten check skill scope enforcement**: Run 22083221872 check passed with 31 files changed vs. expected ~7. Check should fail (not pass) when the diff is significantly wider than the plan scope, rather than rationalizing it as beneficial.
